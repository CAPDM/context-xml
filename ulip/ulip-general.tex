%Baseline setups

\setupbodyfont[modern,11pt]
\setupwhitespace[medium]
\setupalign[right,nothyphenated,verytolerant]
\setupinterlinespace[line=5ex]
\setuppagenumbering[location=]

%XML baseline

\startxmlsetups xml:capdm:base
 \xmlsetsetup{#1}{*}{xml:capdm:*}
 \xmlsetfunction {\xmldocument}{entry}{userdata.xmlfunctions.entry}
\stopxmlsetups

\xmlregisterdocumentsetup{capdm}{xml:capdm:base}

%Entities

\xmltexentity{nbsp}{\ }
\xmltexentity{ndash}{--}
\xmltexentity{amp}{\&}
\xmltexentity{plusmn}{\pm{}}

%Preprocess

\startluacode
function lxml.preprocessor(data)
 for index, value in pairs({
  ['<!DOCTYPE book PUBLIC %"%-//CAPDM Limited//DTD DocBook V4%.1%.2%-Based Extension//EN%" %"http://schemas%.capdm%.com/dbcapdm/dbcapdm%.dtd%" %[[^%]]-%]>'] = '',
  ['<%?capdm %*force_line_stop%?>'] = '<?context-directive injector newline ?>',
  ['<%?capdm %*force_page_break%?>'] = '<?context-directive injector newpage ?>'
  }) do
   data = data:gsub(index, value)
  end
 return data
end
\stopluacode

%Procins

\startsetups xml:directive:injector:newline
 \crlf
\stopsetups

\startsetups xml:directive:injector:newpage
 \page[yes]
\stopsetups

%Hierarchicals

\startxmlsetups xml:capdm:book
 \setupheader[state=high]
 \cbox{\hsize=\makeupwidth\tfd\bf \xmlfirst{#1}{/title}
  \blank
  {\tfb\color[blue]{Copy-edit format generated from XML master}}
  \blank
  {\tfa\color[blue]{\currentdate}}}
 \page[yes]
 \setupheader[state=high]
 \setvariable{book}{title}{\xmlfirst{#1}{/title}}
 \xmlall{#1}{/!title}
\stopxmlsetups

\setuphead[chapter][number=no,header=high]

\startxmlsetups xml:capdm:chapter
 \startchapter[reference=\xmlatt{#1}{id},title=\xmlfirst{#1}{/title}]
  \setupfootertexts[text][{\color[blue]{\getvariable{book}{title}}}][{\color[blue]{\completepagenumber}}][{\color[blue]{\getvariable{book}{title}}}][{\color[blue]{\completepagenumber}}]
  \xmlall{#1}{/!title}
 \stopchapter
 \page[yes]
\stopxmlsetups

%Features

\definehead[LearnObj][section]
\setuphead[LearnObj][number=no,style=bold]

\startxmlsetups xml:capdm:learnobj
 \startLearnObj[title=\xmlfirst{#1}{/title}]
  \xmlall{#1}{/!title}
 \stopLearnObj
\stopxmlsetups

\startxmlsetups xml:capdm:tip
 \xmldoif{#1}{/title}{{\tfa\xmlfirst{#1}{/title}}\blank[small,samepage]}
 \xmlall{#1}{/!title}
\stopxmlsetups

%Lists

\definedescription[varlistentry][headstyle=bold,style=normal,align=flushleft,alternative=serried,width=broad]

\startxmlsetups xml:capdm:variablelist
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:term
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:varlistentry
 \pagebreak[preference]
 \startvarlistentry{\xmlfirst{#1}{/term}}
  {\xmlall{#1}{/!term}}
 \stopvarlistentry
\stopxmlsetups

\definesymbol[9]{}

\startxmlsetups xml:capdm:lists
 \xmlsetsetup{#1}{itemizedlist[@mark='bullet']}{xml:capdm:itemizedlist:bullet}
 \xmlsetsetup{#1}{itemizedlist[@mark='none']}{xml:capdm:itemizedlist:none}
 \xmlsetsetup{#1}{itemizedlist[@mark='dash']}{xml:capdm:itemizedlist:dash}
\stopxmlsetups
\xmlregisterdocumentsetup{capdm}{xml:capdm:lists}

\startxmlsetups xml:capdm:itemizedlist
 {\bf\xmlfirst{#1}{/title}}
 \startitemize[1]
  \xmlall{#1}{/!title}
 \stopitemize
\stopxmlsetups

\startxmlsetups xml:capdm:itemizedlist:bullet
 {\bf\xmlfirst{#1}{/title}}
 \startitemize[1]
  \xmlall{#1}{/!title}
 \stopitemize
\stopxmlsetups

\startxmlsetups xml:capdm:itemizedlist:none
 {\bf\xmlfirst{#1}{/title}}
 \startitemize[9]
  \xmlall{#1}{/!title}
 \stopitemize
\stopxmlsetups

\startxmlsetups xml:capdm:itemizedlist:dash
 {\bf\xmlfirst{#1}{/title}}
 \startitemize[2]
  \xmlall{#1}{/!title}
 \stopitemize
\stopxmlsetups

\startxmlsetups xml:capdm:orderedlist
 \startitemize[n]
  \xmlflush{#1}
 \stopitemize
\stopxmlsetups

\startxmlsetups xml:capdm:listitem
 \xmldoifelse{#1}{ancestor::variablelist}{
  \xmlflush{#1}
 }{
  \startitem
   \xmlflush{#1}
  \stopitem
 }
\stopxmlsetups

%Tables

\setupTABLE[offset=.3em,framecolor=gray,split=yes]

\startxmlsetups xml:capdm:informaltable
 \blank[big,preference]
 {\bf\xmlfirst{#1}{/title}}\blank[small,samepage]
 \bTABLE
  \xmlall{#1}{/!title}
 \eTABLE
\stopxmlsetups

\startxmlsetups xml:capdm:tgroup
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:thead
 \startluacode intablehead = true \stopluacode
 \xmlflush{#1}
 \startluacode intablehead = false \stopluacode
\stopxmlsetups

\startxmlsetups xml:capdm:tbody
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:row
 \bTR
  \xmlflush{#1}
 \eTR
\stopxmlsetups

\startluacode
userdata.xmlfunctions = {}
function userdata.xmlfunctions.entry (t)
  local rows = (t.at.morerows or 0) + 1
  if intablehead then
    context.bTH({nr=rows})
    lxml.flush(t)
    context.eTH()
  else
    context.bTD({nr=rows})
    lxml.flush(t)
    context.eTD()
  end
end
\stopluacode

%Figures

\setupexternalfigures[directory=C:/Work/svn/MPE graphics,maxwidth=\textwidth]

\startxmlsetups xml:capdm:informalfigure
 \blank[big,preference]
 \xmlall{#1}{/!title}
 \xmldoif{#1}{/title}{\blank[small,samepage]\xmlfirst{#1}{/title}}
\stopxmlsetups

\startxmlsetups xml:capdm:mediaobject
 \xmldoifatt{#1}{vendor}{playlist}{\blank[back]\color[blue]{\tfx Video playlist}}
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:inlinemediaobject
 \blank[medium,preference]
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:imageobject
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:images
 \xmlsetsetup{#1}{imagedata[@entityref]}{xml:capdm:imagedata:entityref}
 \xmlsetsetup{#1}{imagedata[@fileref]}{xml:capdm:imagedata:fileref}
\stopxmlsetups
\xmlregisterdocumentsetup{capdm}{xml:capdm:images}

\startxmlsetups xml:capdm:imagedata:entityref
 \starttexcode\externalfigure[\xmlatt{#1}{entityref}][conversion=mp]\stoptexcode
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:imagedata:fileref
 \starttexcode\externalfigure[\xmlatt{#1}{fileref}][conversion=mp]\stoptexcode
 \xmlflush{#1}
\stopxmlsetups

%Callouts

\startxmlsetups xml:capdm:mediaobjectco
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:imageobjectco
 \blank
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:calloutlist
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:callout
 \xmlflush{#1}
\stopxmlsetups

%UQF

\startxmlsetups xml:capdm:task
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:preamble
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:question
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:content
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:answer
 {\tfa\bf Hint}\endgraf
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:questionobject
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:qpart
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:apart
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:ansopt
 \xmlflush{#1}
\stopxmlsetups

\definetextbackground[ModelAnswer]
\setuptextbackground[ModelAnswer][location=paragraph,backgroundcolor=white,framethickness=1pt,frame=on,leftoffset=.5em,rightoffset=.5em,topoffset=.5em,bottomoffset=.5em]

\startxmlsetups xml:capdm:statement
 \blank[big,preference]
 \starttextbackground[ModelAnswer]
  \xmlflush{#1}
 \stoptextbackground
\stopxmlsetups

%Shared

\startxmlsetups xml:capdm:para
 \xmlflush{#1}\endgraf
\stopxmlsetups

\xmlmapvalue{emphasis}{bold}{\bf}
\xmlmapvalue{emphasis}{italic}{\it}

\startxmlsetups xml:capdm:emphasis
 \begingroup
  \xmlvalue{emphasis}{\xmlatt{#1}{role}}{\bf}
  \xmlflush{#1}
 \endgroup
\stopxmlsetups

\startxmlsetups xml:capdm:note
 {\tfx
 \xmlflush{#1}
 }
\stopxmlsetups

\startxmlsetups xml:capdm:title
 \xmlflush{#1}
\stopxmlsetups

\startxmlsetups xml:capdm:bridgehead
 \pagebreak[preference]
 {\tfa\bf\xmlflush{#1}}\endgraf
\stopxmlsetups

\startsetups url
 \setupalign[hyphenated]
\stopsetups

\startxmlsetups xml:capdm:ulink % copy-edit format just needs the text and link
 \bgroup
  \setup[url]
  {\tfxx\color[blue]{{\bf LINK:}}} \xmlflush{#1} {\tfxx\color[blue]{{\bf TO URL:} {\tfx\hyphenatedurl{\xmlatt{#1}{url}}}}}
 \egroup
\stopxmlsetups

\startxmlsetups xml:capdm:link
 {\tfxx\color[blue]{{\bf LINK:}}} \xmlflush{#1} {\tfxx\color[blue]{{\bf TO PAGE:} {\tfx\about[\xmlatt{#1}{linkend}]}}}
\stopxmlsetups

%Process

\starttext
\xmlprocessfile{capdm}{capdm-spina-wb-sample.xml}{}
\stoptext
